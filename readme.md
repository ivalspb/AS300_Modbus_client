# Modbus Client для Delta AS332T

## Обзор проекта

Проект представляет собой клиентское приложение для работы с контроллером Delta AS332T по протоколу Modbus TCP. Приложение обеспечивает мониторинг, управление и визуализацию данных тестовых режимов двигателей.

## Архитектура проекта

### Структура каталогов

```
ModbusClient/
├── CMakeLists.txt
├── src/
│   ├── main.cpp
│   ├── core/                    # Ядро приложения
│   │   ├── interfaces/          # Интерфейсы
│   │   ├── modbus/              # Modbus клиент и обработчики
│   │   ├── mapping/             # Маппинг адресов Delta
│   │   └── connection/          # Управление соединением
│   ├── data/                    # Слой данных
│   │   ├── interfaces/
│   │   └── database/            # Работа с БД
│   ├── monitoring/              # Мониторинг данных
│   ├── control/                 # Управление режимами
│   ├── gui/                     # Пользовательский интерфейс
│   │   ├── mainwindow/
│   │   ├── widgets/
│   │   ├── factories/
│   │   ├── connection/
│   │   ├── monitoring/
│   │   ├── mode_selection/
│   │   └── database/
│   └── export/                  # Экспорт данных
└── tests/                       # Тесты
```

## Основные компоненты

### 1. Core (Ядро)

#### Интерфейсы

**IModbusClient** - основной интерфейс Modbus клиента:
- Управление соединением
- Чтение/запись регистров
- Конфигурация опроса
- Поддержка верификации записи

**IRequestQueue** - интерфейс очереди запросов:
- Приоритетная и обычная очереди
- Поддержка чтения и записи
- Потокобезопасность

**IAddressMapper** - маппинг адресов Delta:
- Преобразование логических адресов в физические
- Поддержка дискретных входов, командных выходов, аналоговых значений

**IIndicator** - интерфейсы индикаторов:
- `IValueIndicator` - базовый интерфейс
- `IDualIndicator` - двойной индикатор (основное/вторичное значение)

#### Реализации Modbus

**DeltaModbusClient** - основная реализация клиента:
- Двухчастотный опрос (20 Гц и 2 Гц)
- Верификация записи регистров
- Автоматическое переподключение
- Приоритетная обработка команд

**ModbusRequestHandler** - обработчик запросов:
- Асинхронная обработка
- Управление интервалами запросов
- Обработка ошибок

**ModbusRequestQueue** - реализация очереди:
- Раздельные очереди для приоритетных и обычных запросов
- Потокобезопасность с использованием мьютексов

#### Маппинг Delta

**DeltaAddressMapper** - маппер адресов Delta AS332T:
- Маппинг дискретных входов S1-S12
- Маппинг командных выходов K1-K6  
- Маппинг аналоговых значений (обороты АД, ТК, СТ)

**DeltaAddressMap** - константы адресов:
- Адреса дискретных входов (0x6000-0x600B)
- Адреса командных выходов (0xA000-0xA008)
- Адреса аналоговых регистров (D10, D21, D23, D41, D43)
- Управляющие регистры (M1-M6, M0, M11, M12, M14)

### 2. Data Layer (Слой данных)

#### DataRepository
- Хранение точек данных в памяти
- Поддержка временных диапазонов
- Эмиссия сигналов при добавлении данных

#### Database Layer
**SqliteDatabaseRepository** - работа с SQLite:
- Сохранение тестовых сессий
- Хранение точек данных
- Поиск и фильтрация данных

**DatabaseAsyncManager** - асинхронный менеджер:
- Неблокирующие операции с БД
- Управление пулом потоков

**DatabaseExportService** - сервис экспорта:
- Экспорт в CSV
- Экспорт в изображение

### 3. Monitoring (Мониторинг)

**DataMonitor** - главный монитор:
- Координация под-мониторов
- Управление таймером обновления
- Централизованное логирование

**DiscreteInputMonitor** - монитор дискретных входов:
- Отслеживание состояний S1-S12
- Обновление индикаторов GUI
- Обработка командных выходов K1-K6

**AnalogValueMonitor** - монитор аналоговых значений:
- Мониторинг оборотов АД, ТК, СТ
- Конвертация сырых значений
- Обновление двойных индикаторов

### 4. Control (Управление)

#### ModeController
- Управление 5 тестовыми режимами:
  1. Расконсервация/Консервация
  2. Холодная прокрутка турбостартера
  3. Регулировка мощности, замер параметров
  4. Холодная прокрутка основного двигателя
  5. Имитация запуска основного двигателя
- Управление регистром D0
- Интеграция с системой записи данных

#### ControlStateMachine
Конечный автомат управления тестированием:
- **STATE_READY_CHECK** - проверка готовности
- **STATE_START_INTERRUPT** - пуск/прерывание
- **STATE_STOP** - остановка
- **STATE_RESTART_EXIT** - повторение/выход

Автомат управляется через M-регистры и отслеживает статусные регистры для автоматических переходов.

#### ControlUIController
- Динамическое обновление UI в зависимости от состояния
- Управление двумя основными кнопками
- Изменение стилей и текста кнопок

### 5. GUI (Пользовательский интерфейс)

#### Основные виджеты

**MainWindow** - главное окно:
- Разделение на вкладки
- Горизонтальный сплиттер
- Управление закрытием приложения

**ConnectionWidget** - подключение:
- Настройка IP и портов
- Индикация статуса подключения

**MonitorWidget** - панель мониторинга:
- Индикаторы дискретных входов S1-S12
- Индикаторы командных выходов K1-K6
- Двойные индикаторы аналоговых значений
- Кнопки управления автоматом состояний

**ChartWidget** - графики:
- Мульти-осевые графики оборотов
- Спидометры для текущих значений
- Управление масштабом и временным диапазоном
- Экспорт данных

#### View Controllers

**ConnectionViewController** - управление подключением
**ModeSelectionViewController** - выбор режима тестирования
**MonitoringViewController** - управление мониторингом
**DatabaseViewController** - работа с историей тестов

#### WidgetFactory
Фабрика для создания виджетов:
- Централизованное создание UI компонентов
- Управление стилями и размерами
- Предоставление доступа к элементам управления

### 6. Export (Экспорт)

**PngExportStrategy** - стратегия экспорта в PNG:
- Рендеринг виджетов в изображения
- Сохранение в формате PNG

## Тестовые режимы

### Режим 1: Расконсервация/Консервация
- Настройка D0 = 1
- Управление консервационными процессами

### Режим 2: Холодная прокрутка турбостартера  
- Настройка D0 = 2
- Мониторинг оборотов ТК

### Режим 3: Регулировка мощности, замер параметров
- Настройка D0 = 3
- Комплексный мониторинг всех параметров

### Режим 4: Холодная прокрутка основного двигателя
- Настройка D0 = 4
- Мониторинг оборотов СТ

### Режим 5: Имитация запуска основного двигателя
- Настройка D0 = 5
- Имитация полного цикла запуска

## Особенности реализации

### Двухчастотный опрос
- **Высокая частота (20 Гц)**: Аналоговые значения (обороты)
- **Низкая частота (2 Гц)**: Дискретные входы, командные выходы, статусные регистры

### Верификация записи
- Автоматическая проверка записанных значений
- Таймауты верификации
- Повторные попытки при ошибках

### Автомат состояний
- Детектирование статусов через M-регистры
- Автоматические переходы между состояниями
- Интеграция с системой записи графиков

### Мульти-осевые графики
- Раздельные оси для АД, ТК, СТ
- Автоматическое и ручное масштабирование
- Zoom и панорамирование

## Сборка и зависимости

### Зависимости
- Qt 5.15+ (Core, Widgets, Charts, Network, SerialBus, Sql)
- SQLite3
- CMake 3.16+

### Сборка
```bash
mkdir build && cd build
cmake ..
make
```

## Использование

1. **Подключение**: Настройте IP адрес и порты в разделе "Управление"
2. **Выбор режима**: Выберите тестовый режим из 5 доступных
3. **Запуск теста**: Используйте автомат состояний для управления процессом
4. **Мониторинг**: Наблюдайте за данными в реальном времени на графиках и индикаторах
5. **Анализ**: Просматривайте исторические данные в разделе "История"

## Безопасность

- Проверка состояний перед выполнением команд
- Защита от одновременного запуска нескольких тестов
- Автоматическая остановка при потере соединения
- Сохранение данных при аварийном завершении

Проект демонстрирует лучшие практики разработки сложных промышленных приложений с использованием многослойной архитектуры, паттернов проектирования и современных подходов к UI/UX.
